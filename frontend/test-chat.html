test-chat.html

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Socket.IO Test – Presence, Chat & API Logs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{--pri:#4f46e5}
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:20px;background:#fafafa}
    h2{margin:8px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    input,button{padding:8px;border:1px solid #ddd;border-radius:8px}
    input{flex:1}
    button{background:var(--pri);color:#fff;border:none;cursor:pointer}
    button.ghost{background:#e5e7eb;color:#111}
    #status{font-size:14px;margin-bottom:8px}
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;align-items:start}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}
    ul{list-style:none;padding:0;margin:0;max-height:420px;overflow:auto}
    li{display:flex;gap:8px;padding:8px;border-bottom:1px dashed #eee}
    .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;background:#ddd}
    .meta{font-size:12px;color:#666}
    code{background:#111;color:#0f0;padding:2px 6px;border-radius:6px}
    #onlineList li{align-items:center}
    #onlineList img{width:20px;height:20px;border-radius:50%;object-fit:cover;background:#ddd}
    #apiLog{background:#111;color:#0f0;padding:8px;border-radius:8px;max-height:220px;overflow:auto}
  </style>
</head>
<body>
  <h2>✅ Test chat + Online presence + API error/logs</h2>
  <div id="status">Đang kết nối…</div>

  <div class="wrap">
    <!-- Cột trái: điều khiển -->
    <div class="card">
      <h3>Hồ sơ (profile)</h3>
      <div class="row"><input id="username" placeholder="Tên (vd: Lam)" /></div>
      <div class="row"><input id="avatar" placeholder="https://i.pravatar.cc/100?u=Lam" /></div>
      <div class="row"><button onclick="setProfile()">Set profile</button></div>

      <hr/>

      <h3>Gửi global</h3>
      <div class="row">
        <input id="globalMsg" placeholder="Tin nhắn global…" />
        <button onclick="sendGlobal()">Gửi</button>
      </div>

      <hr/>

      <h3>Phòng</h3>
      <div class="row"><input id="roomId" placeholder="room-1" /></div>
      <div class="row">
        <button onclick="joinRoom()">Join room</button>
        <button class="ghost" onclick="leaveRoom()">Leave room</button>
      </div>
      <div class="row">
        <input id="roomMsg" placeholder="Tin nhắn trong phòng…" />
        <button onclick="sendRoom()">Gửi phòng</button>
      </div>
      <div style="margin-top:10px;font-size:13px">
        Thành viên phòng hiện tại: <code id="roomUsers">[]</code>
      </div>

      <hr/>

      <h3>Users online (<span id="onlineCount">0</span>)</h3>
      <ul id="onlineList"></ul>

      <hr/>

      <h3>Day 11 – Error & Logs</h3>
      <div class="row">
        <button onclick="pingHealth()">GET /api/health</button>
        <button class="ghost" onclick="call404()">GET 404</button>
      </div>
      <div class="row">
        <button onclick="postMessageOk()">POST /api/messages (OK)</button>
        <button class="ghost" onclick="postMessageBad()">POST /api/messages (400)</button>
      </div>
      <pre id="apiLog"></pre>
    </div>

    <!-- Cột phải: hiển thị -->
    <div class="card">
      <h3>Lịch sử / Tin mới</h3>
      <ul id="list"></ul>
    </div>
  </div>

  <script>
    // KẾT NỐI
    const socket = io("http://localhost:3000");
    const API = "http://localhost:3000";
    const $ = (id)=>document.getElementById(id);
    const listEl = $("list");

    // Render 1 message (global/room đều dùng)
    function renderMsg(m){
      const li = document.createElement("li");
      const av = document.createElement("img");
      av.className = "avatar";
      av.src = m.avatar || "https://placehold.co/72x72?text=?";

      const right = document.createElement("div");
      right.innerHTML =
        `<div><strong>${m.username || "Anonymous"}</strong> — ${m.message || ""}</div>
         <div class="meta">id: ${m.id ?? "-"} · room: ${m.roomId ?? "global"} · ts: ${new Date(m.ts||Date.now()).toLocaleTimeString()}</div>`;
      li.appendChild(av);
      li.appendChild(right);
      listEl.appendChild(li);
      listEl.scrollTop = listEl.scrollHeight;
    }

    // ==== API test (Day 11) ====
    function logApi(title, data) {
      const pre = $("apiLog");
      const line = `\n=== ${title} ===\n` + JSON.stringify(data, null, 2) + "\n";
      pre.textContent += line;
      pre.scrollTop = pre.scrollHeight;
    }

    async function pingHealth() {
      try {
        const res = await fetch(`${API}/api/health`);
        const json = await res.json();
        logApi("GET /api/health", { status: res.status, json, reqId: res.headers.get('x-request-id') });
      } catch (e) {
        logApi("GET /api/health ERROR", { message: e.message });
      }
    }

    async function call404() {
      try {
        const res = await fetch(`${API}/api/nope`);
        const json = await res.json();
        logApi("GET /api/nope (404)", { status: res.status, json, reqId: res.headers.get('x-request-id') });
      } catch (e) {
        logApi("GET /api/nope ERROR", { message: e.message });
      }
    }

    async function postMessageOk() {
      try {
        const body = { username: $("username").value || "Tester", message: "Hello from REST" };
        const res = await fetch(`${API}/api/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const json = await res.json();
        logApi("POST /api/messages (OK)", { status: res.status, json, reqId: res.headers.get('x-request-id') });
      } catch (e) {
        logApi("POST /api/messages (OK) ERROR", { message: e.message });
      }
    }

    async function postMessageBad() {
      try {
        // Thiếu 'message' để BE trả 400
        const res = await fetch(`${API}/api/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: "BadUser" })
        });
        const json = await res.json();
        logApi("POST /api/messages (400)", { status: res.status, json, reqId: res.headers.get('x-request-id') });
      } catch (e) {
        logApi("POST /api/messages (400) ERROR", { message: e.message });
      }
    }

    // TRẠNG THÁI
    socket.on("connect", ()=>{
      $("status").innerHTML = `Đã kết nối: <code>${socket.id}</code>`;
      // auto set_profile nếu người dùng đã gõ sẵn tên/avatar trước khi load
      const username = $("username").value.trim();
      const avatar = $("avatar").value.trim();
      if (username || avatar) socket.emit("set_profile", { username, avatar });
    });
    socket.on("disconnect", ()=>{ $("status").innerHTML = `Mất kết nối`; });

    // ONLINE USERS
    socket.on("online_users", (list)=>{ renderOnline(list); });

    // HISTORY GLOBAL
    socket.on("history", (arr)=>{
      listEl.innerHTML = "";
      arr.forEach(renderMsg);
    });

    // HISTORY ROOM
    socket.on("history_room", ({roomId, messages})=>{
      renderMsg({ username: "[system]", message: `-- History of ${roomId} --`, ts: Date.now() });
      messages.forEach(renderMsg);
    });

    // TIN NHẮN MỚI
    socket.on("receive_message", (m)=>renderMsg(m));

    // THÀNH VIÊN PHÒNG
    socket.on("room_users", ({roomId, members})=>{
      $("roomUsers").textContent = JSON.stringify(members);
    });

    // Lỗi từ socket (nếu BE emit)
    socket.on("error", (e) => { logApi("SOCKET error", e); });
    socket.on("error_message", (e) => { logApi("SOCKET error_message", e); });

    // Render danh sách online
    function renderOnline(list) {
      const ul = $("onlineList");
      const count = $("onlineCount");
      ul.innerHTML = "";
      list.forEach(u => {
        const li = document.createElement("li");
        const img = document.createElement("img");
        img.src = u.avatar || "https://placehold.co/40x40?text=?";
        const name = document.createElement("span");
        name.textContent = u.username || "Anonymous";
        li.appendChild(img); li.appendChild(name);
        ul.appendChild(li);
      });
      count.textContent = String(list.length);
    }

    // ACTIONS
    function setProfile(){
      const username = $("username").value.trim();
      const avatar = $("avatar").value.trim();
      socket.emit("set_profile", { username, avatar });
    }

    function sendGlobal(){
      const message = $("globalMsg").value.trim();
      if(!message) return;
      // server sẽ lấy username/avatar từ profile đang lưu
      socket.emit("send_message", { message });
      $("globalMsg").value = "";
    }

    function joinRoom(){
      const roomId = $("roomId").value.trim();
      if(!roomId) return;
      const username = $("username").value.trim();
      const avatar = $("avatar").value.trim();
      socket.emit("join_room", { roomId, username, avatar });
    }

    function leaveRoom(){
      const roomId = $("roomId").value.trim();
      if(!roomId) return;
      socket.emit("leave_room", { roomId });
    }

    function sendRoom(){
      const roomId = $("roomId").value.trim();
      const message = $("roomMsg").value.trim();
      if(!roomId || !message) return;
      socket.emit("send_room_message", { roomId, message });
      $("roomMsg").value = "";
    }
  </script>
</body>
</html>
